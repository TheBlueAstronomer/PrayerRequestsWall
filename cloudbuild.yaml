substitutions:
  _ARTIFACT_REGION: "asia-south1"
  _REPOSITORY: "prayer-repository"
  _IMAGE_NAME: "prayer-wall-app"
  _VM_NAME: "project-intercessor"
  _VM_ZONE: "asia-south1-c"

steps:
  # 1. Build the container image with Commit SHA tag
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '-t'
      - '${_ARTIFACT_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$SHORT_SHA'
      - '-t'
      - '${_ARTIFACT_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:latest'
      - '.'

  # 2. Push the container image (both tags)
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_ARTIFACT_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$SHORT_SHA'

  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'push'
      - '${_ARTIFACT_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:latest'

  # 3. SSH into VM and deploy specific version
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        IMAGE="us-central1-docker.pkg.dev/PROJECT_ID/prayer-repository/prayer-wall:$SHORT_SHA"
        # Since we use asia-south1, we should stick to it unless you INTENDED to switch to us-central1.
        # However, to be safe and use existing vars:
        IMAGE="${_ARTIFACT_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$SHORT_SHA"
        
        # Upload deploy scripts to VM (run this in cloudbuild.yaml)
        # Upload deploy scripts to VM (run this in cloudbuild.yaml)
        echo "Uploading deploy scripts..."
        # copy the script to the VM
        gcloud compute scp --zone=${_VM_ZONE} "deploy-docker.sh" "${_VM_NAME}:/opt/deploy/deploy-docker.sh"
        # make executable and set safe perms (owned by root, executable by all)
        gcloud compute ssh "${_VM_NAME}" --zone=${_VM_ZONE} --command "sudo chown root:root /opt/deploy/deploy-docker.sh && sudo chmod 755 /opt/deploy/deploy-docker.sh"

        # Execute deployment remotely
        echo "Executing remote deployment..."
        gcloud compute ssh "${_VM_NAME}" --zone="${_VM_ZONE}" --command "export DEPLOY_IMAGE='${IMAGE}' && export HOST_DATA_PATH='/var/intercessor/data' && /opt/deploy/deploy-docker.sh"

images:
  - '${_ARTIFACT_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:$SHORT_SHA'
  - '${_ARTIFACT_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_IMAGE_NAME}:latest'

options:
  logging: CLOUD_LOGGING_ONLY
